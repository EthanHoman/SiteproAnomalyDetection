# Pump Anomaly Detection System - Mermaid Diagrams

This file contains the three main system diagrams in Mermaid format.

---

## 1. System Class Diagram

```mermaid
classDiagram
    %% Core Analysis System
    class PumpMonitor {
        -baseline: dict
        -tolerances: dict
        -operational_df: DataFrame
        -model: RandomForestRegressor
        +load_operational_data(filepath)
        +analyze()
        +generate_report()
        +get_current_status()
    }

    class DataProcessor {
        +load_baseline_data(filepath) dict
        +load_operational_data(filepath) DataFrame
        +calculate_deviations(df, baseline) DataFrame
        +validate_data(df)
    }

    class ToleranceChecker {
        -tolerances: dict
        +select_tolerance_category(app, hp) str
        +check_tolerances(deviations) dict
        +classify_status(violations) str
    }

    class PredictiveModel {
        -model: RandomForestRegressor
        -scaler: StandardScaler
        +engineer_features(df) DataFrame
        +train_failure_predictor(X, y) model
        +predict_failure(data) dict
    }

    class Visualizer {
        +plot_dashboard(df)
        +plot_timeline(events)
        +plot_trends(df)
    }

    %% Edge Deployment System
    class EdgeInference {
        -model: object
        -baseline: dict
        -tolerances: dict
        -api_client: AnomalyAPIClient
        -last_reported: dict
        +run_inference(input_csv, output_json)
        +calculate_deviations(row) dict
        +check_tolerances(deviations) dict
        +format_anomaly_payload(results) dict
        +should_report_anomaly() bool
    }

    class AnomalyAPIClient {
        -base_url: str
        -bearer_token: str
        +submit_anomaly(payload) dict
        +query_anomalies(filters) dict
    }

    class ArtifactPackager {
        -pump_name: str
        -version: str
        +load_baseline(file)
        +package(output_path)
    }

    %% Data Models
    class BaselineData {
        +well_id: str
        +baseline_flow_gpm: float
        +baseline_discharge_pressure_psi: float
        +baseline_power_hp: float
        +baseline_efficiency_percent: float
    }

    class AnomalyPayload {
        +sourceType: str
        +description: str
        +siteId: int
        +pumpId: int
        +timestamp: str
        +additionalContext: dict
        +metadata: dict
    }

    %% Relationships
    PumpMonitor --> DataProcessor : uses
    PumpMonitor --> ToleranceChecker : uses
    PumpMonitor --> PredictiveModel : uses
    PumpMonitor --> Visualizer : uses
    PumpMonitor ..> BaselineData : processes

    EdgeInference --> AnomalyAPIClient : uses
    EdgeInference ..> AnomalyPayload : creates

    ArtifactPackager ..> PredictiveModel : packages
    ArtifactPackager --> EdgeInference : creates artifact for

    note for PumpMonitor "Main orchestrator for\ntraining and analysis\n\nPhase 1: Core System"
    note for EdgeInference "Runs on edge device\n(Raspberry Pi)\n\nPhase 2B: Edge Deployment"
```

---

## 2. System Use Case Diagram

```mermaid
graph LR
    %% Actors
    analyst((Data Analyst))
    devops((DevOps Engineer))
    edge((Edge Device))
    api((Central API))

    %% Phase 1: Training & Analysis
    subgraph Phase1[Phase 1: Training & Analysis]
        UC1[UC1: Load Pump Data]
        UC2[UC2: Calculate Deviations]
        UC3[UC3: Check Tolerances]
        UC4[UC4: Train ML Model]
        UC5[UC5: Generate Report]
    end

    %% Phase 2B: Edge Deployment
    subgraph Phase2B[Phase 2B: Edge Deployment]
        UC6[UC6: Package Artifact]
        UC7[UC7: Deploy to Edge]
        UC8[UC8: Run Inference]
        UC9[UC9: Detect Anomaly]
        UC10[UC10: Send JSON to API]
    end

    %% Analyst workflows
    analyst --> UC1
    analyst --> UC2
    analyst --> UC3
    analyst --> UC5

    %% DevOps workflows
    devops --> UC4
    devops --> UC6
    devops --> UC7

    %% Edge device workflows
    edge --> UC8
    edge --> UC9

    %% API interactions
    UC10 -.->|POST JSON payload| api

    %% Workflow dependencies
    UC2 -.->|include| UC1
    UC3 -.->|include| UC2
    UC5 -.->|include| UC3
    UC5 -.->|extend| UC4

    UC7 -.->|include| UC6
    UC8 -.->|requires| UC7
    UC9 -.->|part of| UC8
    UC10 -.->|triggered by| UC9
```

---

## 3. System Sequence Diagram - Anomaly Detection and API Reporting

```mermaid
sequenceDiagram
    participant User
    participant EdgeInference
    participant SensorData
    participant MLModel
    participant APIClient
    participant CentralAPI

    User->>EdgeInference: run_inference(sensor_data.csv)
    EdgeInference->>SensorData: read_csv()
    SensorData-->>EdgeInference: pump readings

    EdgeInference->>EdgeInference: calculate_deviations()
    Note over EdgeInference: Compare current vs baseline<br/>Flow: +15%, Head: +10%,<br/>Power: +8.5%, Efficiency: -1.2%

    EdgeInference->>EdgeInference: check_tolerances()
    Note over EdgeInference: Apply Category 1U thresholds<br/>Flow > +10% ✗ EXCEEDED<br/>Head > +6% ✗ EXCEEDED

    EdgeInference->>EdgeInference: classify_status()
    Note over EdgeInference: Status = "Warning"

    EdgeInference->>MLModel: predict_failure(features)
    MLModel-->>EdgeInference: RUL = 12.5 days, confidence = 0.87

    EdgeInference->>EdgeInference: should_report_anomaly()
    Note over EdgeInference: Check debounce (60 min)<br/>Decision: REPORT

    EdgeInference->>EdgeInference: format_anomaly_payload()
    Note over EdgeInference: Build JSON:<br/>{<br/>"sourceType": "log",<br/>"description": "Flow exceeded 15.0%",<br/>"siteId": 35482,<br/>"pumpId": 1,<br/>"additionalContext": {...},<br/>"metadata": {...}<br/>}

    EdgeInference->>APIClient: submit_anomaly(payload)
    APIClient->>CentralAPI: POST /edge/anomalies
    Note right of CentralAPI: Authorization: Bearer TOKEN<br/>Content-Type: application/json

    alt Success
        CentralAPI-->>APIClient: 200 OK {id: 12345}
        APIClient-->>EdgeInference: success
        EdgeInference->>EdgeInference: update_debounce_tracker()
    else Failure
        CentralAPI-->>APIClient: 500 Error
        APIClient->>APIClient: retry with backoff
        APIClient->>CentralAPI: POST /edge/anomalies (retry)
        alt Retry Success
            CentralAPI-->>APIClient: 200 OK
            APIClient-->>EdgeInference: success
        else All Retries Failed
            APIClient-->>EdgeInference: error
            EdgeInference->>EdgeInference: save_unsent_anomaly()
        end
    end

    EdgeInference->>EdgeInference: save_results_json()
    EdgeInference-->>User: Inference complete
```

---

## Key Features Highlighted in These Diagrams

### Class Diagram
- **Core Analysis System**: PumpMonitor orchestrates data processing, tolerance checking, ML predictions, and visualization
- **Edge Deployment System**: EdgeInference handles real-time monitoring on Raspberry Pi with API reporting
- **Data Models**: BaselineData and AnomalyPayload define the data structures

### Use Case Diagram
- **Phase 1 Workflows**: Data loading → Deviation calculation → Tolerance checking → ML training → Report generation
- **Phase 2B Workflows**: Artifact packaging → Edge deployment → Real-time inference → Anomaly detection → API reporting
- **Actors**: Data Analyst, DevOps Engineer, Edge Device, Central API

### Sequence Diagram
- **Simple workflow**: User triggers inference → System detects anomaly → Reports to API
- **Key steps**: Read sensor data → Calculate deviations → Check tolerances → ML prediction → Send to API
- **Tolerance checking**: Category 1U thresholds (Flow +10%, Head +6%)
- **ML prediction**: Predicts remaining useful life (RUL) and confidence
- **Debouncing**: Prevents duplicate reports within 60 minutes
- **Retry logic**: Automatic retry on API failure with exponential backoff
- **JSON payload**: Structured data sent to POST /edge/anomalies endpoint

---

## Notes

- **Mermaid rendering**: These diagrams can be rendered in GitHub README.md, GitLab, Notion, or any Mermaid-compatible viewer
- **Real-time collaboration**: Mermaid diagrams are text-based, making them easy to version control and collaborate on
- **Dynamic updates**: Edit the diagram code directly to update the visualization
- **Export options**: Can be exported to PNG, SVG, or PDF using Mermaid CLI or online tools

---

**Created**: November 19, 2025
**Format**: Mermaid v10+
**Source**: Converted from PlantUML FINAL_DIAGRAMS.puml
